---
name: NC旋盤ノーズR補正計算
description: NC旋盤のノーズR補正座標計算に関する正確な計算式と実装ガイド。計算エンジンの修正・拡張時に参照すべき唯一の信頼できるソース。
---

# NC旋盤ノーズR補正計算スキル

このスキルは、NC旋盤座標計算ツールのノーズR補正ロジックに関わる作業を行う際に参照すべき、**統一された正確な計算定義**です。

> **重要**: このスキルの内容は、2026年1月の物理整合性監査（Total Truth Audit）で1μm精度で検証済みです。

---

## 1. 基本概念

### 1.1 仮想刃先点と工具中心

NC旋盤の補正は「仮想刃先点 (O)」と「工具中心 (P)」の関係を理解することが本質です。

```
      ノーズR（円）
       ╭───╮
      /  ●  \   ← 工具中心 P
     │       │
     ╰───────╯
         ↓
    仮想刃先点 O（チップ番号で決まる）
```

### 1.2 座標系と指令方式

| 項目 | 値 |
|------|-----|
| X軸出力 | **直径値** |
| I値出力 | **半径値** |
| Z軸正方向 | テールストック方向 |

---

## 2. チップ番号オフセット定義（Fanuc/JIS規格）

### 正規定義テーブル（半径値）

| Tip | Xオフセット | Zオフセット | 物理配置 |
|:---:|:---:|:---:|:---|
| **1** | $-R$ | $+R$ | 内径/奥 |
| **2** | $-R$ | $-R$ | 内径/前 |
| **3** | $+R$ | $+R$ | 外径/前 (標準) |
| **4** | $+R$ | $-R$ | 外径/奥 |
| **5** | $0$ | $+R$ | 端面Z+ |
| **6** | $-R$ | $0$ | 端面X- |
| **7** | $0$ | $-R$ | 端面Z- |
| **8** | $+R$ | $0$ | 端面X+ |

### 変換公式

**プログラム点 O を工具中心 P から算出:**
```
O = P - V_offset × dirX
```

- `dirX`: 刃物台係数 (後刃物台=1, 前刃物台=-1)
- X座標は直径値のため、Xオフセットは `2R` で適用

---

## 3. ユニバーサル二等分線投影法

機械の物理構成（刃物台位置、加工勝手）に対応した補正計算法。

### 3.1 物理補正係数

```typescript
const dirX = toolPost === 'rear' ? 1 : -1   // 刃物台
const sideSign = isExternal ? 1 : -1        // 内外径
```

### 3.2 法線方向の決定

```typescript
// 法線ベクトルの極性
nx = (nx / len) * (sideSign * dirX)  // X: 両方の影響
nz = (nz / len) * sideSign           // Z: 内外径のみ
```

### 3.3 スパイク防止ガード

鋭角接続（約140度以上の旋回）で座標発散を防ぐ：

```typescript
const dist = Math.min(noseR * 4.0, noseR / cosHalf)
```

---

## 4. コーナーR計算

### 4.1 角R（凸）と隅R（凹）の違い

| 項目 | 角R（凸） | 隅R（凹） |
|------|----------|----------|
| 円弧中心 | 経路の内側 | 経路の外側 |
| 補正半径 | `R + noseR` | `R - noseR` |
| 接点距離 | `R / tan(θ/2)` | `R × tan(θ)` |

**🔴 重要**: 上記の「補正半径」は、補正計算時（CenterTrackCalculator等）に使用します。
形状展開時（calculateCorner等）では、**図面値のRをそのまま使用**してください。

### 4.2 ワーク形状計算と補正の分離原則

ノーズR補正の実装では、以下の2段階を厳密に分離する必要があります：

**第1段階：形状展開（図面通り）**
```typescript
// calculateCorner() の役割
const cornerR = 0.5  // 図面値（noseRを加算しない！）
const tDist = cornerR / Math.tan(half)
const entryZ = cornerZ + u1z * tDist
```

**第2段階：補正適用**
```typescript
// CenterTrackCalculator の役割
const offsetR = isConvex ? (cornerR + noseR) : (cornerR - noseR)
const compensatedZ = workZ + normalZ * noseR
```

この分離により：
- ワーク形状は図面通りに正確に計算される
- ノーズR補正は一箇所で統一的に適用される
- 二重補正のバグを防止できる

### 4.3 I/K値の計算

```typescript
I = (centerX - startX) / 2  // 半径値！
K = centerZ - startZ
```

---

## 5. 検証済み計算値

### 45度テーパー接続（R0.8）

| 項目 | 理論値 | 実装値 |
|------|--------|--------|
| Zシフト量 | -0.469mm | -0.469mm ✓ |

### 計算式

```
fz = R × tan(θ/2)
fx = 2R × (1 - tan((90-θ)/2))
```

---

## 6. G41/G42判定マトリクス

| 刃物台 | 加工種類 | 切削方向 | コード |
|--------|----------|----------|--------|
| 前 | 外径 | -Z | G42 |
| 前 | 内径 | -Z | G41 |
| 後 | 外径 | -Z | G41 |
| 後 | 内径 | -Z | G42 |

---

## 7. 実装ファイルへのマッピング

| 機能 | ファイル | 関数/クラス |
|------|----------|-------------|
| 補正計算 | `noseRCompensation.ts` | `CenterTrackCalculator` |
| オフセット変換 | `noseRCompensation.ts` | `pToO()` |
| 円弧半径補正 | `noseRCompensation.ts` | `calculateArcOffset()` |
| コーナー計算 | `shape.ts` | `calculateCorner()` |

---

## 8. よくある間違いと対処

### ❌ 間違い: I値を直径で出力

```typescript
// 間違い
I = centerX - startX

// 正しい
I = (centerX - startX) / 2
```

### ❌ 間違い: 角Rと隅Rに同じ式を使う

```
角R: tan(θ/2) を使用
隅R: tan(θ) を使用 ← 全角！
```

### ❌ 間違い: 刃物台位置を無視

```typescript
// 間違い: 常に同じ方向に補正
nx = nx / len * sign

// 正しい: 刃物台で反転
nx = (nx / len) * (sideSign * dirX)
```

---

## 9. 参考文献

- **Peter Smid "CNC Programming Handbook"** (Chapter 26, 27)
- **工場長のネタ帳** (座標計算シリーズ)
- **中村留精密工業 寺子屋** (ノーズR補正解説)

---

このスキルの内容に矛盾する古いドキュメントがある場合は、このスキルを正として修正してください。
