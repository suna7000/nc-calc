---
name: NC旋盤ノーズR補正計算
description: NC旋盤のノーズR補正座標計算に関する正確な計算式と実装ガイド。計算エンジンの修正・拡張時に参照すべき唯一の信頼できるソース。
---

# NC旋盤ノーズR補正計算スキル

このスキルは、NC旋盤座標計算ツールのノーズR補正ロジックの**唯一の正解定義**です。

## 1. 本質的コンセプト：幾何学不変の法則

ノーズR補正の本質は、刃物台（トルレット）の位置に関わらず、**「ワーク形状と工具先端Rの物理的な相対関係」**だけで決まります。

### 1.1 仮想刃先点(O) と 工具中心(P)
- **$P$**: チップの物理的な円の中心（チップの半径 $R$ ぶん、素材から離れた位置）。
- **$O$**: プログラムで指令する仮想の角（チップ先端の $X, Z$ 接線の交点）。

### 1.2 計算の2ステップ（Center Track Method）
1.  **物理オフセット**: ワーク表面から法線方向に $R$ だけ離れた座標 $P$ を求める。
2.  **逆算**: ステップ1で求めた $P$ から、チップ番号ごとに決まった固定ベクトル $\vec{V}$ を引いて、プログラム座標 $O$ を求める。

---

## 2. チップ番号の物理定義（標準Rear基準）

チップ番号によるオフセットベクトル $\vec{V}$ は、標準的な座標系（$X$ 直径、$Z$ 長さ）において以下のように定義されます。
$\vec{V} = [dx, dz]$ （半径値）としたとき、$P = O + \vec{V}$ となります。

| Tip | dx (X方向) | dz (Z方向) | 物理的な意味 |
|:---:|:---:|:---:|:---|
| **1** | $-R$ | $+R$ | 内径 / 奥面向き |
| **2** | $-R$ | $-R$ | 内径 / 手前面向き |
| **3** | $+R$ | $+R$ | 外径 / 手前面向き（標準） |
| **4** | $+R$ | $-R$ | 外径 / 奥面向き |

> [!IMPORTANT]
> **刃物台による符号反転は不要です。** $P$ から $O$ を求める際の極性は、チップ番号の定義によって一意に決まります。

---

## 3. 法線ベクトルの決定

各セグメント（直線・円弧）における法線ベクトル $\vec{n} = [nx, nz]$ は、常に**「ワークから空気方向（チップ側）」**に向く必要があります。

### 3.1 物理的な符号判定
- **外径加工 (External)**: チップは常に直径の大きい方に位置するため、法線は **$nx > 0$** 方向に向ける。
- **内径加工 (Internal)**: チップは常に直径の小さい（中心に近い）方に位置するため、法線は **$nx < 0$** 方向に向ける。

```typescript
// nx, nz は進行方向に対して垂直なベクトル
const len = Math.sqrt(nx * nx + nz * nz)
const rNx = nx / len
const rNz = nz / len

// 外径なら X+ 方向、内径なら X- 方向を強制
const sign = (rNx * sideSign > 0) ? 1 : -1
return { nx: rNx * sign, nz: rNz * sign }
```

---

## 4. 45度テーパーでの理論値（Peter Smid 理論）

45度テーパー（外径）と水平面の接続部における補正偏差の公式は以下の通りです。

### 4.1 計算式
- **$Z$ シフト量**: $fz = R \cdot \tan(22.5^\circ) = R \cdot (1 - \sin(45^\circ)) / \cos(45^\circ) \approx 0.414 \cdot R$
- **$X$ シフト量**: $fx = 2R \cdot (1 - \tan(22.5^\circ)) \approx 1.171 \cdot R$（直径値）

> [!TIP]
> **R0.4 の場合**: $fx = 0.234mm$、$fz = 0.165mm$ となります。
> ワーク座標 $X46.207$ に対し、プログラム座標は $46.207 - 0.234 = X45.973$ となります。

---

## 5. よくある間違い（※絶対に避けること）

### ❌ 刃物台(Front/Rear)で補正方向を反転させる
補正座標そのものは、刃物台の位置に関わらず一定です。反転させるべきなのは「描画上の見た目」や「NC装置内部の処理」であり、計算エンジンが算出するプログラム座標値ではありません。

### ❌ $X$ 軸加減算の取り違え
外径加工において、前方向へのテーパー加工（直径減少）を行う際、ノーズR補正後のプログラム $X$ 座標は、**ワーク座標よりも必ず内側（小さく）**なります。これが逆転している場合は、チップ定義か法線計算の符号が間違っています。

---

## 6. 実装の整合性確認 (Implementation Audit)

- `noseRCompensation.ts`: `CenterTrackCalculator` は上記の幾何学不変ロジックを実装。
- `shape.ts`: 形状展開時には補正を考慮せず、純粋なワーク座標を出力すること。

---
このドキュメントは、あらゆる計算不整合が発生した際の唯一の「真実のソース」として機能します。
