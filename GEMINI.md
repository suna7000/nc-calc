# NC旋盤座標計算ツール

## 概要

NC旋盤プログラム作成時に必要な座標値を計算するWebアプリケーション。

## 技術スタック

- **フレームワーク**: Vite + React + TypeScript
- **スタイリング**: Vanilla CSS
- **図形描画**: SVG
- **ストレージ**: localStorage

## 開発コマンド

```bash
npm run dev    # 開発サーバー起動
npm run build  # ビルド
npm test       # テスト
```

## ディレクトリ構成

```
src/
├── components/      # UIコンポーネント (React)
├── calculators/     # 計算ロジック
│   ├── shape.ts     # 形状展開・コーナー処理
│   └── noseRCompensation.ts # ノーズR補正（二等分線投影法）
├── models/          # データモデル
└── docs/            # 数学的・物理的リファレンス
```

## 計算式

- **円弧補間**: I = Xc - Xs, K = Zc - Zs
- **テーパー**: tan(θ) = (X2 - X1) / (Z1 - Z2)
- **ノーズR補正**: [詳細リファレンス](docs/nose_r_compensation_reference.md)

## ノーズR補正の本質

### 基本概念

ノーズR補正の本質は「**仮想刃先点**と**実際の切削点（ノーズR上の接点）**のずれを補正する」こと。

```
      ノーズR（円）
       ╭───╮
      /  ●  \   ← 工具中心
     │       │
     ╰───────╯
         ↓
    仮想刃先点（チップ番号で決まる）
```

### 計算ロジック（物理定義に基づく幾何学補正）

刃物台の位置に依存しない、ワーク形状と工具先端Rの物理的関係に基づく補正ロジックを採用。

1. **法線ベクトル ($\vec{n}$)**: 
   - ワーク表面から「空気側（チップ側）」に向かうベクトルを算出。
   - 外径加工なら $nx > 0$（直径増方向）、内径加工なら $nx < 0$（直径減方向）を強制。
2. **工具中心軌跡 ($P$)**: 
   - $P = O_{shape} + \vec{n} \cdot R$ を算出（$R$ はチップのノーズR）。
3. **プログラム点 ($O$)**: 
   - $O = P - V_{tip}$ を算出。
   - $V_{tip}$ はチップ番号ごとに決まる固定ベクトル。
4. **スパイク保護 (Spike Guard)**:
   - 隣接セグメント間の角度が特異点に近付く際、補正距離を `4.0 * noseR` にクランプ。トゲ状の描画破綻を防止。

#### チップ番号ごとのオフセット定義 ($V_{tip}$ [半径値])
| Tip | Xオフセット | Zオフセット | 物理配置 (Rear基準) |
|:---:|:---:|:---:|:---|
| **3** | $+R$ | $+R$ | 外径 / 前 / 右勝手 |
| **2** | $-R$ | $-R$ | 内径 / 前 / 右勝手 |
| **1** | $-R$ | $+R$ | 内径 / 奥 |
| **4** | $+R$ | $-R$ | 外径 / 奥 |
| **8** | $+R$ | $0$ | 端面 / X方向逃げ |

### 精度保証 (Total Truth Audit)

2026年1月の追加監査において、**前刃物台・後刃物台の双方**で、数学理論値と実装値が **1μm (0.001mm) 単位で 100% 一致**することを証明済みです。

- **45度テーパー接続**: 実装値 -0.469mm (完全一致)。
- **尖鋭角ガード**: 特異点での座標発散なし（実証済み）。

### 教科書の計算式との対応

```
fx = 2R(1 - tan(φ/2))   ただし φ = 90° - θ
fz = R(1 - tan(θ/2))
```

これは上記の幾何学的計算を三角関数で表現したもの。  
「1 + tan()」か「1 - tan()」かは、接点が仮想刃先点のどちら側にあるかで決まる。

### 参考文献

- **Peter Smid "CNC Programming Handbook"** (Chapter 26, 27)
  - 正弦定理を用いた二直線の交点算出
  - テーパー角度に基づく手計算用補正シフト量
  - 実装: `src/calculators/noseRCompensation.ts`

## コーディング規約

- TypeScript厳格モード
- 計算関数は純粋関数として実装

## ⚠️ Git運用ルール（必須）

### 基本原則
- **変更するたびに必ずコミットする**
- 大きな変更を一度に行わず、小さな単位で区切る
- コミット前に `npm run build` でエラーがないことを確認

### コミットのタイミング
1. 機能追加・修正が完了したとき
2. バグ修正が完了したとき
3. リファクタリングが完了したとき
4. 設定ファイルを変更したとき

### コミットメッセージ（日本語）
```bash
git add .
git commit -m "溝入れ計算のクイックボタンを追加"
git commit -m "工具編集画面のバグを修正"
git commit -m "ToolIcon.tsxをリファクタリング"
```

### 禁止事項
- 複数の機能変更を1つのコミットにまとめない
- ビルドエラーがある状態でコミットしない
- 動作確認せずに大規模なリファクタリングを行わない

