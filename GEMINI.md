# NC旋盤座標計算ツール

## 概要

NC旋盤プログラム作成時に必要な座標値を計算するWebアプリケーション。

## 技術スタック

- **フレームワーク**: Vite + React + TypeScript
- **スタイリング**: Vanilla CSS
- **図形描画**: SVG
- **ストレージ**: localStorage

## 開発コマンド

```bash
npm run dev    # 開発サーバー起動
npm run build  # ビルド
npm test       # テスト
```

## ディレクトリ構成

```
src/
├── components/      # UIコンポーネント
├── calculators/     # 計算ロジック（arc, taper, chamfer, groove, noseRadius）
└── features/        # 機能モジュール（history, naturalInput）
```

## 計算式

- **円弧補間**: I = Xc - Xs, K = Zc - Zs
- **テーパー**: tan(θ) = (X2 - X1) / (Z1 - Z2)
- **ノーズR補正**: [詳細リファレンス](docs/nose_r_compensation_reference.md)

## ノーズR補正の本質

### 基本概念

ノーズR補正の本質は「**仮想刃先点**と**実際の切削点（ノーズR上の接点）**のずれを補正する」こと。

```
      ノーズR（円）
       ╭───╮
      /  ●  \   ← 工具中心
     │       │
     ╰───────╯
         ↓
    仮想刃先点（チップ番号で決まる）
```

### 計算ロジック（幾何学的アプローチ）

1. **仮想刃先点**: チップ番号（1～8）によって決まる固定位置
   - チップ番号3（外径標準）: 工具中心から (-R, -R) の位置

2. **実際の接点**: セグメントの角度（切削面の法線方向）によって変化
   - Z軸に平行な面 → ノーズRの最もZ-側の点
   - X軸に平行な端面 → ノーズRの最もX+側の点
   - テーパー角θの面 → 法線方向に対応する点

3. **補正量の計算**:
   ```
   接点位置 = 工具中心 + R × (sin(90°-θ), cos(90°-θ))
   仮想刃先 = 工具中心 + (チップ番号による定数)
   補正量(fx, fz) = 接点位置 - 仮想刃先位置
   ```

### 教科書の計算式との対応

```
fx = 2R(1 - tan(φ/2))   ただし φ = 90° - θ
fz = R(1 - tan(θ/2))
```

これは上記の幾何学的計算を三角関数で表現したもの。  
「1 + tan()」か「1 - tan()」かは、接点が仮想刃先点のどちら側にあるかで決まる。

### 参考文献

- **Peter Smid "CNC Programming Handbook"** (Chapter 26, 27)
  - 正弦定理を用いた二直線の交点算出
  - テーパー角度に基づく手計算用補正シフト量
  - 実装: `src/calculators/noseRCompensation.ts`

## コーディング規約

- TypeScript厳格モード
- 計算関数は純粋関数として実装

## ⚠️ Git運用ルール（必須）

### 基本原則
- **変更するたびに必ずコミットする**
- 大きな変更を一度に行わず、小さな単位で区切る
- コミット前に `npm run build` でエラーがないことを確認

### コミットのタイミング
1. 機能追加・修正が完了したとき
2. バグ修正が完了したとき
3. リファクタリングが完了したとき
4. 設定ファイルを変更したとき

### コミットメッセージ（日本語）
```bash
git add .
git commit -m "溝入れ計算のクイックボタンを追加"
git commit -m "工具編集画面のバグを修正"
git commit -m "ToolIcon.tsxをリファクタリング"
```

### 禁止事項
- 複数の機能変更を1つのコミットにまとめない
- ビルドエラーがある状態でコミットしない
- 動作確認せずに大規模なリファクタリングを行わない

