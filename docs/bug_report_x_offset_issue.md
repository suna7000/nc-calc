# 不具合報告: P3以降のX座標ずれ

**報告日**: 2026年1月24日  
**重要度**: 高  
**ステータス**: 未解決

---

## 1. 問題の概要

ノーズR補正計算において、2番目以降の角Rコーナー（P3, P4, P5）で**X座標に大きなずれ**が発生しています。

---

## 2. 再現手順

### 入力値
```
P1: X46.5 Z0
P2: X46.5 Z-101 (角R0.5)
P3: X42 Z-103.25 (角R2)
P4: X42 Z-118.85 (角R2)
P5: X45 Z-136 (角R2)
P6: X45 Z-150
ノーズR: 0.4
```

### 実行コマンド
```bash
npm test -- --run src/calculators/__tests__/user_input_verification.test.ts
```

---

## 3. 期待値 vs 実際の出力

| ポイント | 期待X | 期待Z | 実際X | 実際Z | X誤差 | Z誤差 |
|----------|-------|-------|-------|-------|-------|-------|
| P2 R始点 | 46.5 | -101.19 | 46.5 | -101.193 | **0.000** ✅ | -0.003 ✅ |
| P2 R終点 | 45.97 | -101.82 | 45.973 | -101.829 | **0.003** ✅ | -0.009 ✅ |
| P3 R始点 | 42.93 | -103.34 | **40.108** | -104.195 | **-2.822** ❌ | -0.855 |
| P3 R終点 | 42 | -104.47 | **38** | -104.478 | **-4.000** ❌ | -0.008 |

---

## 4. 観察事項

1. **P2（最初のコーナー）は正確**
   - X誤差: 0.003mm, Z誤差: -0.009mm → 許容範囲内

2. **P3以降でX座標が急激に減少**
   - 期待値 X42.93 に対して実際は X40.108（約2.8mm少ない）
   - 期待値 X42 に対して実際は X38（4mm少ない）

3. **Z座標は比較的近い**
   - Z方向の誤差は0.01〜0.9mm程度

---

## 5. 推定原因

### 仮説1: 法線方向の誤計算（有力）
テーパー区間（P2→P3）の法線ベクトル計算で、X成分の符号または大きさが誤っている可能性。

```typescript
// noseRCompensation.ts - getNormalAt()
nx = -dz; nz = dx  // ← この計算で法線が逆方向を向いている？
```

### 仮説2: sideSign (内外径判定) の誤適用
外径加工なのに、`sideSign = -1` が適用されている、または途中で切り替わっている可能性。

### 仮説3: 二等分線投影距離 (dist) の過大評価
`calculateBisector()` で算出される `dist` が大きすぎて、補正点がワーク内側に入り込んでいる可能性。

---

## 6. 調査すべき箇所

| ファイル | 関数 | 確認ポイント |
|---------|------|-------------|
| `noseRCompensation.ts` | `getNormalAt()` | 法線ベクトルの符号・方向 |
| `noseRCompensation.ts` | `calculateBisector()` | dist の値と bx, bz の方向 |
| `noseRCompensation.ts` | `calculate()` | P_points の中間計算値 |
| `shape.ts` | `calculateCorner()` | セグメント分解の入力値 |

---

## 7. 関連ファイル

- テストファイル: `src/calculators/__tests__/user_input_verification.test.ts`
- 補正エンジン: `src/calculators/noseRCompensation.ts`
- 形状計算: `src/calculators/shape.ts`

---

## 8. 次のアクション

1. `getNormalAt()` のログ出力を追加して法線ベクトルを確認
2. `calculateBisector()` の中間値（dist, bx, bz）をデバッグ出力
3. P2→P3間のテーパー角度と法線の関係を手計算と照合
