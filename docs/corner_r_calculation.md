# NC旋盤 コーナーR/C計算の技術知見

## 概要

NC旋盤プログラミングにおける円弧補間（G02/G03）と、コーナー処理（隅R、角R、角C）の計算方法についての技術的知見。

---

## G02/G03の基本

| Gコード | 回転方向 | 説明 |
|---------|----------|------|
| **G02** | CW（時計回り） | XZ平面でY軸正方向から見た時計回り |
| **G03** | CCW（反時計回り） | XZ平面でY軸正方向から見た反時計回り |

### I/K値の指定

- **I**: 始点から円弧中心までのX方向距離（半径値で指定）
- **K**: 始点から円弧中心までのZ方向距離

```
I = centerX - startX
K = centerZ - startZ
```

---

## 凸角（角R）と凹角（隅R）の幾何学的違い

### 凸角（角R / Outside Corner / Convex Fillet）

外径の肩部など、「外側に突き出た角」に丸みをつける処理。

```
工具経路:
                ○ ← 円弧中心（ワーク側・経路の内側）
    ────┐     ╱
         ╲   ╱
          ╲ ╱ ← 円弧
           │
           │
           ▼
```

- 円弧中心は工具経路の**内側**（ワーク側）にある
- 二等分線方向に円弧中心を配置

### 凹角（隅R / Inside Corner / Concave Fillet）

ボアの底角など、「内側に凹んだ角」に丸みをつける処理。

```
工具経路:
           │
           │
      ╱ ╲ ← 円弧
     ╱   ╲
────┘     ○ ← 円弧中心（ワークの外側・経路の外側）
```

- 円弧中心は工具経路の**外側**にある
- 二等分線の**反対方向**に円弧中心を配置

---

## 円弧中心の計算式

### 共通の計算

```typescript
// 2本の線分のベクトル（コーナー点からの方向）
const v1 = normalize(prevPoint - cornerPoint)  // 前の点への方向
const v2 = normalize(nextPoint - cornerPoint)  // 次の点への方向

// 二等分線方向
const bisector = normalize(v1 + v2)

// 半角の計算
const dot = v1 · v2
const halfAngle = acos(dot) / 2

// 中心までの距離
const centerDist = R / sin(halfAngle)

// 接点までの距離
const tangentDist = R * tan(halfAngle)  // または R / tan(halfAngle)
```

### 角R（凸角）の場合

```typescript
// 円弧中心は二等分線方向
const centerX = cornerX + bisector.x * centerDist
const centerZ = cornerZ + bisector.z * centerDist
```

### 隅R（凹角）の場合 - 詳細

隅Rは凸角とは異なる幾何学を使用する：

```typescript
// ベクトル定義
// u1 = (p1 - p2) / len = p2→p1方向
// u2 = (p3 - p2) / len = p2→p3方向

// 進行方向
const inDir = -u1   // p1→p2方向（コーナーへ向かう）
const outDir = u2   // p2→p3方向（コーナーから出る）← 重要: -u2ではなくu2

// 各線分に垂直な方向（進行方向の左側 = ワークから遠ざかる方向）
// 左回転: (x,z) → (-z, x)
const perpIn = (-inDir.z, inDir.x)    // 左回転
const perpOut = (-outDir.z, outDir.x) // 左回転

// 円弧中心: 両方向にRオフセット
center = corner + perpIn * R + perpOut * R

// 接点
entry = center - perpIn * R
exit = center - perpOut * R
```

**例**: X=100,Z=-50から X=200,Z=-50への隅R5
- inDir = (0, -1), outDir = (1, 0)
- perpIn = (1, 0), perpOut = (0, 1)
- center = (50, -50) + (5, 0) + (0, 5) = (55, -45)
- entry = (55, -45) - (5, 0) = (50, -45) → X=100, Z=-45
- exit = (55, -45) - (0, 5) = (55, -50) → X=110, Z=-50
- I = 55 - 50 = 5, K = -45 - (-45) = 0

---

## G02/G03の判定

G02/G03の判定は、以下の要素で決まる：

1. **工具の進行方向と曲がる方向**（ベクトル外積で判定）
2. **刃物台の位置**（前刃物台/後刃物台で反転）
3. **凹角/凸角の違い**（円弧中心の位置が異なるため、結果として反転）

### 実装での対応

凹角と凸角で円弧中心の位置が反対になるため、I/K値の符号が自然に逆になる。
これにより、ベクトル外積によるG02/G03判定が自動的に正しく反転する。

---

## 機械設定による影響

| 設定 | 影響 |
|------|------|
| **前刃物台** | 標準的なG02/G03判定 |
| **後刃物台** | X軸が反転するためG02↔G03が反転 |
| **切削方向+Z** | 通常(-Z)と逆なのでG02↔G03が反転 |

---

## Rの自動調整 (Limit Check)

セグメント長（線分長）に対して大きすぎるRが指定された場合、計算エラーや形状の破綻を防ぐため、自動的にR値を縮小するロジックを実装。

### 調整基準
- **最大許容距離**: 隣接するセグメントの短い方の長さの 99%
- **調整後のR**: `adjustedRadius = maxDistance * Math.tan(halfAngle)`

これによる「1μm の妥協」が、プログラム全体の数値的安定性と現場での加工継続性を担保する。

---

## 参考資料

- Gコードの円弧補間は主にI/K指令とR指令の2種類
- 180度を超える円弧はI/K指令を使用（R指令では曖昧）
- 真円（360度）はI/K指令のみで指定可能
- **検証済み精度**: 1μm (Total Truth Audit 2026-01 証明済み)
