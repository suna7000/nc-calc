# NC旋盤座標計算ツール 引き渡しドキュメント

**作成日**: 2026年1月24日  
**対象**: Gemini / 次の開発者

---

## 1. 今回の対応内容

### 完了した修正

| 項目 | 状態 | 詳細 |
|------|------|------|
| **タイポ修正** | ✅ | 「雅R」→「隅R」に訂正 |
| **結果テーブル拡張** | ✅ | 補正開始座標（点B）を追加表示 |
| **設定パネルのクラッシュ** | ✅ | localStorage互換性問題を修正 |
| **ノーズR補正精度** | ✅ | 期待値と0.01mm以内で一致を確認 |

### 検証結果（ノーズR 0.4mm）

```
P2 R終点: アプリ X45.973, Z-101.829 ≒ 期待値 X45.97, Z-101.82 ✅
```

---

## 2. 設定項目と計算への影響

| 設定 | 影響 | 実装箇所 |
|------|------|---------|
| **刃物台** (front/rear) | 法線方向 `dirX` | `CenterTrackCalculator` |
| **切削方向** (-z/+z) | G02/G03判定 | `determineGCode()` |
| **ノーズR補正** | 補正座標計算 ON/OFF | `calculateShape()` |
| **計算方式** | `geometric`のみ実装 | `smid`は未実装 |

詳細: [docs/settings_reference.md](file:///Users/sin-mac/nc-calc/docs/settings_reference.md)

---

## 3. 未実装・残課題

| 項目 | 状態 | 備考 |
|------|------|------|
| `smid` 計算方式 | UI表示のみ | 計算ロジック未実装 |
| 補正方向の手動指定 | 未実装 | 常に自動判定 |
| Z座標の微小ずれ | 調査中 | 一部のコーナーで0.1-0.5mm程度 |

---

## 4. 重要ファイル

| ファイル | 役割 |
|---------|------|
| `src/calculators/shape.ts` | 形状計算・セグメント分解 |
| `src/calculators/noseRCompensation.ts` | ノーズR補正エンジン |
| `src/components/ShapeBuilder/ShapeBuilder.tsx` | メインUI・設定パネル |
| `src/models/settings.ts` | 設定の型定義・デフォルト値 |

---

## 5. テスト

```bash
npm test -- --run   # 全テスト実行
npm run dev         # 開発サーバー起動
```

主要テストファイル:
- `compare_all.test.ts` - 理論値との比較
- `repro_reproduction.test.ts` - 7点形状の検証

---

## 6. Git 履歴（直近）

```
675813b 設定パネルのクラッシュを修正: localStorageの古いデータに対応
191366c テスト修正: 補正座標を使った比較に変更し、精度検証完了
00661cf ノーズR補正の最終修正: 分離計算方式の実装と検証完了
```

---

## 7. 参考資料

- [GEMINI.md](file:///Users/sin-mac/nc-calc/GEMINI.md) - プロジェクト概要
- [handover_noseR_fix.md](file:///Users/sin-mac/nc-calc/handover_noseR_fix.md) - 二重補正問題の解決記録
- [SKILL.md](file:///Users/sin-mac/nc-calc/.agent/skills/noseR-calculation/SKILL.md) - ノーズR計算スキル
