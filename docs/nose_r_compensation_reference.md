# ノーズR補正 計算式リファレンス

このドキュメントはNC旋盤のノーズR補正における座標計算式をまとめたものです。

## 情報源

| ソース | 内容 | URL |
|--------|------|-----|
| 工場長のネタ帳 | 図解付き計算例 | koujoucho-neta.com |
| 中村留精密工業 | 仮想刃先点の解説 | nakamura-tome.co.jp/terakoya/noseR/ |
| NCプログラム基礎知識 | Gコード・教科書PDF | s-projects.net |

---

## 基本概念

### 仮想刃先点番号とオフセット ($V_{offset}$)

NC 装置は内部的に工具中心 (P) で計算を行いますが、プログラム座標は仮想刃先点 (O) に基づきます。

| チップ番号 | Xオフセット(直径) | Zオフセット | 物理定義 |
|:---:|:---:|:---:|:---|
| **3** | $+2R$ | $+R$ | 外径/前（標準） |
| **2** | $-2R$ | $-R$ | 内径/前（標準） |
| **1** | $-2R$ | $+R$ | 内径/奥 |
| **7** | $0$ | $-R$ | 端面裏中心 |

**変換式**: $O' = P - V_{offset}$

### G41/G42/G40

| コード | 意味 | 使用例 |
|--------|------|--------|
| G41 | 進行方向の左側に補正 | 内径加工 |
| G42 | 進行方向の右側に補正 | 外径加工 |
| G40 | 補正キャンセル | 加工終了時 |

---

## 二等分線投影法 (Bisector Projection)

二つのセグメント（直線/円弧）の接続点において、それぞれの法線ベクトルの二等分線方向に中心をオフセットする手法。

### 1. テーパー接続カドのシフト量
θが 90 度のカド（平坦面から垂直面）ではなく、任意の角度で交差する場合の真理値。

- **Bisector Distance**: $D = R \cdot \csc(\alpha/2)$
- **Tangent Point Offset**: $T = R \cdot \cot(\alpha/2)$

**例 (45度カドの監査値)**:
平坦面(Z)から45度テーパー(X/Z)への接続点。
- 幾何学的期待値 (O'z): **-0.469mm** (R0.8時)
- この値は、プログラム上のカド座標から数理的に導出される「現場の正解」です。

---

### 2. テーパーから角R（凸）への接点計算

**条件**: θ°テーパー → 角R（凸形状）

```
接点Z補正 = R × tan(θ/2)  ← 半角を使用
```

**B点（接点）の計算**:
```javascript
B点_Z = 基準Z + R × tan(θ/2)
B点_X = 基準X // 変化なし
```

**A点（円弧終点）の計算**:
```javascript
bd間 = R × (1 - cos(θ))
de間 = R × sin(θ)
A点_X = B点_X - 2 × bd間
A点_Z = B点_Z - de間
```

**例**: 30°テーパー → 10R（角）、Φ100、Z50
- B点: X100, Z52.679
- A点: X97.32, Z47.679

---

### 3. テーパーから隅R（凹）への接点計算

**条件**: θ°テーパー → 隅R（凹形状）

```
接点X補正 = R × tan(θ)  ← 全角を使用（角Rと異なる！）
```

**B点（接点）の計算**:
```javascript
B点_X = 基準X + 2 × R × tan(θ)
B点_Z = 基準Z // 変化なし
```

**A点（円弧終点）の計算**:
```javascript
// 補角(90°-θ)を使用
cd間 = R × (1 - cos(90°-θ)) = R × (1 - sin(θ))
de間 = R × sin(90°-θ) = R × cos(θ)
A点_X = B点_X - 2 × de間
A点_Z = B点_Z - cd間
```

**例**: 30°テーパー → 5R（隅）、Φ100、Z50
- tan(30°) = 0.5774
- B点: X105.774, Z50
- A点: X97.114, Z47.5

> **重要**: 角R（凸）は `tan(θ/2)`、隅R（凹）は `tan(θ)` を使用

---

### 4. 円弧から円弧への接点計算

**条件**: R1 → R2（段差 d が小さい場合）

```
三平方の定理を使用
```

**計算方法**:
```javascript
// R1の中心からR2の接線までの距離を計算
bc間 = √(R1² - (R1 - d)²)
```

**例**: 5R → 段差1mm
- ab間 = 5 - 1 = 4
- bc間 = √(25 - 16) = 3
- B点_Z = A点_Z + 3

---

### 5. ノーズRオフセット（補正後座標計算）

**直線（テーパー）の補正**:
```javascript
// 法線方向にノーズR分オフセット
θ = テーパー角（rad）
ΔZ = noseR × (1 - sin(θ))
ΔX = noseR × (1 - cos(θ)) × 2  // 直径値
```

**円弧の補正**:
```javascript
// 隅R（凹）
補正後半径 = ワーク半径 - ノーズR

// 角R（凸）
補正後半径 = ワーク半径 + ノーズR
```

---

## 🔴 重要：ワーク形状計算と補正の分離原則

### 計算の2段階構造

ノーズR補正において、**ワーク形状の幾何計算**と**工具補正**は完全に分離する必要があります。

#### 第1段階：ワーク形状の幾何展開（図面通りのR値を使用）

```javascript
// calculateCorner などの形状展開関数
// 引数: 図面上のR値（例: 0.5mm）、ノーズRは考慮しない

const cornerR = 0.5  // 図面値そのまま
const tDist = cornerR / Math.tan(half)  // 接線距離

// 接点座標
const entryZ = cornerZ + u1z * tDist
const exitZ = cornerZ + u2z * tDist
```

**結果**: 純粋なワーク形状の座標（補正なし）

#### 第2段階：ノーズR補正の適用

```javascript
// CenterTrackCalculator または補正エンジン
// 引数: ワーク形状座標、ノーズR、チップ番号

// 法線方向にノーズR分オフセット
const compensatedZ = workZ + normalZ * noseR

// チップ番号に応じたオフセット変換
const programZ = centerZ - tipOffsetZ
```

**結果**: 実際のNCプログラム座標

### ❌ よくある間違い

```javascript
// 間違い：第1段階で補正Rを使用
const compensatedR = cornerR + noseR  // ← これが二重補正の原因！
const tDist = compensatedR / Math.tan(half)
```

この方法では：
1. 接点計算でノーズR分を加算
2. 補正計算でさらにノーズR分を加算
3. 結果として**2倍近くの補正**がかかる

### ✅ 実測データによる検証（2026年1月）

**入力**:
- 図面R: 0.5mm
- ノーズR: 0.4mm
- テーパー角: 45度
- コーナー点: Z-101mm

**誤った計算（補正Rを使用）**:
```
補正R = 0.5 + 0.4 = 0.9mm
接線距離 = 0.9 / tan(22.5°) = 2.173mm
接点Z = -101 + 2.173 = -98.827mm  ← Z+方向に大きく戻る
```

**正しい計算（図面Rで計算→補正）**:
```
接線距離 = 0.5 / tan(22.5°) = 1.207mm
接点Z = -101 + 1.207 = -99.793mm
補正量 fz = 0.4 × (1 - tan(22.5°)) = 0.234mm
最終座標 = -99.793 - 1.400 = -101.19mm  ✅ 実測値と一致
```

**差**: 約2mm（ノーズRの約5倍）

---

## 実装時の注意事項

1. **直径値 vs 半径値**: X座標は直径値で計算することが多い
2. **角度の単位**: JavaScript の Math 関数はラジアンを使用
3. **丸め誤差**: 小数点以下3桁で丸める（0.001mm精度）
4. **符号の向き**: 切削方向（+Z/-Z）で補正の向きが変わる
5. **🔴 分離原則**: `calculateCorner` 等の形状展開関数ではノーズRを加算しない

---

## 参考リンク

- [工場長のネタ帳 - 座標計算その２](https://koujoucho-neta.com/hnpv6sy6vacnfwfprkprbj65aqtsax)
- [工場長のネタ帳 - 座標計算その３](https://koujoucho-neta.com/xaxsazzdryxpkywmh3uuvdqbmx8vgu)
- [工場長のネタ帳 - 円弧計算](https://koujoucho-neta.com/8e9yrmzxtmt45zd8wbumy4upu69w9d)
- [中村留 - ノーズR補正](https://www.nakamura-tome.co.jp/terakoya/noseR/)
- [NCプログラム基礎知識](https://s-projects.net/)
