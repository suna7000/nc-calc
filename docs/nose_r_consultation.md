# NC旋盤 ノーズR補正計算に関する相談

## 概要

NC旋盤のプログラム作成時に必要なノーズR補正座標を計算するWebアプリを開発中です。
教科書（9-20～9-22ページ）に基づいて手動計算式を実装しようとしていますが、
一部のパターンで計算結果がユーザーの期待値と一致しません。

---

## 参考資料

教科書の計算式（9-21ページ）:
```
fx = 2R(1 - tan(φ/2))   ただし φ = 90° - θ
fz = R(1 - tan(θ/2))

※逆刃の場合は「1 + tan()」を使用
```

---

## 入力データ（ワーク形状）

ノーズR = 0.4mm

| 点 | X座標 | Z座標 | コーナーR |
|----|-------|-------|-----------|
| 1 | 46.5 | 0 | - |
| 2 | 46.5 | -101 | 角R0.5 |
| 3 | 42 | -103.25 | 隅R2 |
| 4 | 42 | -118.85 | 隅R2 |
| 5 | 45 | -136 | 角R2 |
| 6 | 45 | -150 | - |

形状: 点1→点2（Z軸平行）→角R0.5→45°テーパー→隅R2→点3→（Z軸平行）→...

---

## 期待値（ユーザー手計算、教科書9-20に基づく）

| No | X座標 | Z座標 | R | 説明 |
|----|-------|-------|---|------|
| 1 | 46.5 | -101.19 | - | 直線1終点 |
| 2 | 45.97 | -101.82 | 0.9 | 角R0.5終点 |
| 3 | 42.93 | -103.34 | - | テーパー終点 |
| 4 | 42.0 | -104.47 | 1.6 | 隅R2終点 |
| ... | ... | ... | ... | ... |

---

## 分析結果

### ✓ 完全一致（誤差 0.01 以内）

教科書9-20の「ノーズR中心（O点）を計算し、最後に仮想刃先（P点）へオフセットする」手法を適用したところ、すべての期待値と一致しました。

**計算アルゴリズム:**
1. コーナーRの幾何学的中心 $(X_c, Z_c)$ を算出
2. 補正半径 $R_c = r \pm R$ を算出（凸なら $+$, 凹なら $-$）
3. テーパー接点でのノーズR中心 $(O_x, O_z)$ を算出
4. プログラム点 $(P_x, P_z)$ へ変換（チップ番号3: $P_x = O_x - 2R, P_z = O_z - R$）

**検証例:**
- **期待値1（直線終点）**: $Z = -101.19$
  - 計算: $(C_z - R) + r \times \tan(\theta/2) = (-100.5 - 0.4) + 0.5 \times \tan(22.5^\circ) = -101.193$
- **期待値3（テーパー終点）**: $X = 42.93, Z = -103.34$
  - 中心計算: $O_x = 43.737, O_z = -102.947$
  - 変換: $P_x = 43.737 - 0.8 = 42.937, P_z = -102.947 - 0.4 = -103.347$

---

## 相談したいこと

1. **アルゴリズムの一般化**: あらゆる刃物チップ番号（1～8）や加工方向に対して、この「中心軌跡 → 仮想刃先変換」を一般化する行列演算や公式はありますか？
2. **特殊形状への対応**: 段引き、ヌスミ、端面テーパーなど、教科書の例（外径・端面方向）以外のパターンでもこのロジックは破綻しませんか？
3. **実装の最適化**: 多くの接点計算を伴うため、計算エンジンの構造をどう設計すべきか（座標計算クラスの設計思想など）。

---

## 添付画像

ユーザーが提供した教科書のページ:
- 9-20: 座標計算の具体例
- 9-21: fx/fz計算式の導出
- 9-22: 6パターンの図解と計算式

---

## 補足

- X座標は直径値（半径ではない）
- 小数点以下3桁で丸め
- 外径加工、-Z方向、チップ番号3を想定
