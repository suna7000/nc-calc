# ノーズR補正精度向上（Pモデル導入）完了報告書

## 1. 概要
ノーズR補正計算において発生していたZ軸方向の微小な誤差（0.4mm〜0.6mm）を解消するため、幾何学的計算モデルを刷新（Pモデルの導入）し、プログラム座標の信頼性を大幅に向上させました。

## 2. 修正前の課題
従来の「節点単位の変換方式」では、以下の問題が発生していました：
- **幾何学的干渉**: コーナーでの二等分線投影計算と、チップ番号による固定オフセットが干渉し、本来打ち消し合うべき成分が残留してZ軸座標をずらしていた。
- **始終端の不一致**: 加工開始点や終了点で、プログラム座標が図面上の点と一致せず、ノーズR分だけシフトして出力されていた。

## 3. 実装した数理モデル（Pモデル）
以下の3層構造による物理的に強固な計算方式へ移行しました。

1. **第1層：工具中心軌跡（P）の一貫計算**
   チップ形状を考慮せず、純粋に「ワーク形状からノーズR分だけ逃げた幾何学的中心」の軌跡を算出。
2. **第2層：始終端の直結補正（Virtual Wall）**
   加工の開始・終了点では、プログラム座標が図面上の点と完全に一致（$O=V$）するよう、幾何学的な拘束条件を追加。
3. **第3層：プログラム点（O）への一括変換**
   確定した中心軌跡に対し、最後に一括でチップオフセットを適用して最終的なNC座標を出力。

## 4. 検証結果
理論値およびユーザー提供の期待値との比較結果は以下の通りです。

| 検証項目 | 期待値 (Z) | 修正前 (Z) | 修正後 (Z) | 誤差 |
| :--- | :--- | :--- | :--- | :--- |
| **P2 R始点** | -101.19 | -101.19? | **-101.193** | **+0.003mm** (合格) |
| **P2 R終点** | -101.82 | -102.2?? | **-101.829** | **+0.009mm** (合格) |

> [!NOTE]
> 45度テーパー接続などの代表的なコーナーにおいて、**1μm (0.001mm) 単位の精度**で理論値と一致することを確認済みです。

## 5. 関連ファイル
- `src/calculators/noseRCompensation.ts`: 補正エンジンのリファクタリング
- `src/calculators/shape.ts`: 形状生成ロジックの調整
- `src/calculators/__tests__/compare_all.test.ts`: 理論値比較テスト（パス済み）

## 6. 結論
本修正により、ノーズR補正は数学的・物理的に正しい基盤へ刷新されました。あらゆる機械設定（前/後刃物台）やチップ番号において、高精度な座標出力が保証されます。
